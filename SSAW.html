<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹¸ç‰‡è¨ºæ–·èˆ‡è‡ªæˆ‘æª¢æ¸¬å ±å‘Šç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0d9488', 
                        'secondary': '#0f766e',
                        'accent': '#fbbf24', 
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3ff6;
        }
        .submit-btn {
            transition: all 0.2s ease-in-out;
        }
        
        /* Markdown æ¨£å¼æ¸²æŸ“ */
        #reportContent h3 {
            font-weight: bold;
            font-size: 1.125rem; 
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: #1f2937; 
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 5px;
        }
        #reportContent ul, #reportContent ol {
            padding-left: 1.5rem;
            list-style-type: disc;
            margin-top: 0.5rem;
        }
        #reportContent ul li, #reportContent ol li {
            margin-bottom: 0.25rem;
        }
        #reportContent p {
            margin-bottom: 0.5rem;
        }
        #reportContent pre {
            background-color: #f0fdfa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 0.875rem;
            color: #0f766e;
        }
        #reportContent table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        #reportContent th, #reportContent td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #reportContent th {
            background-color: #f0fdfa;
            font-weight: bold;
        }
        .knowledge-table th, .knowledge-table td {
            padding: 8px;
            border: 1px solid #e2e8f0;
        }
        .knowledge-table th {
            background-color: #e0f2f1;
            font-weight: 600;
            color: #0f766e;
            text-align: center;
        }
        .knowledge-table tr:nth-child(even) {
            background-color: #f0fdfa;
        }
    </style>
</head>
<body>

<div class="min-h-screen p-4 sm:p-6 lg:p-8 flex items-start justify-center">
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 sm:p-10 w-full">
        
        <header class="mb-8 border-b pb-4 text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-primary mb-2">é‹¸ç‰‡å•é¡Œè¨ºæ–·èˆ‡è‡ªæˆ‘æª¢æ¸¬</h1>
            <p class="text-gray-600">è«‹ä»”ç´°å¡«å¯«ä»¥ä¸‹ä¸‰å€å¡Šè³‡è¨Šï¼Œä»¥ç”Ÿæˆè©³ç´°çš„åˆæ­¥è¨ºæ–·å ±å‘Šã€‚</p>
        </header>

        <form id="sawbladeReportForm">
            
            <!-- å€å¡Šä¸€ï¼šå®¢æˆ¶åŠå…¬å¸è³‡è¨Š -->
            <div class="bg-gray-50 p-5 rounded-lg mb-8 shadow-inner">
                <h2 class="text-xl font-bold mb-4 text-primary border-b pb-2">å€å¡Šä¸€ï¼šå®¢æˆ¶åŠè¯ç¹«è³‡è¨Š</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="companyName" class="block text-sm font-medium text-gray-700">å…¬å¸åç¨±</label>
                        <input type="text" id="companyName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border">
                    </div>
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">è¯çµ¡äººå§“å *</label>
                        <input type="text" id="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border">
                    </div>
                    <div class="md:col-span-2">
                        <label for="email" class="block text-sm font-medium text-gray-700">å®¢æˆ¶ä¿¡ç®± (Email, å ±å‘Šå°‡ç”¨æ­¤ä¿¡ç®±å¯„å‡º) *</label>
                        <input type="email" id="email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border" placeholder="è«‹å¡«å¯«æœ‰æ•ˆä¿¡ç®±">
                    </div>
                </div>
            </div>

            <!-- å€å¡ŠäºŒï¼šé‹¸ç‰‡è¦æ ¼èˆ‡å•é¡Œæè¿° -->
            <div class="bg-teal-50 p-5 rounded-lg mb-8 shadow-inner border border-teal-200">
                <h2 class="text-xl font-bold mb-4 text-secondary border-b pb-2">å€å¡ŠäºŒï¼šé‹¸ç‰‡è¦æ ¼ã€åƒæ•¸èˆ‡å•é¡Œæè¿°</h2>
                
                <!-- é‹¸ç‰‡è¦æ ¼ (5 æ¬„: å¤–å¾‘/åˆ‡å¹…/é½’æ•¸/å…§å¾‘/é½’å‹) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                    <div>
                        <label for="outerDia" class="block text-sm font-medium text-gray-700">2. é‹¸ç‰‡å¤–å¾‘ (mm) *</label>
                        <input type="number" id="outerDia" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border" placeholder="ä¾‹å¦‚ï¼š255">
                    </div>
                    <div>
                        <label for="kerf" class="block text-sm font-medium text-gray-700">2. é½’åš/åˆ‡å¹… (mm) *</label>
                        <input type="number" step="0.01" id="kerf" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border" placeholder="ä¾‹å¦‚ï¼š3.2">
                    </div>
                    <div>
                        <label for="toothCount" class="block text-sm font-medium text-gray-700">2. é½’æ•¸ (T) *</label>
                        <input type="number" id="toothCount" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border" placeholder="ä¾‹å¦‚ï¼š100">
                    </div>
                    <div>
                        <label for="innerDia" class="block text-sm font-medium text-gray-700">é‹¸ç‰‡å…§å¾‘ (mm) *</label>
                        <select id="innerDia" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border bg-white">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="19">19</option>
                            <option value="25.4">25.4</option>
                            <option value="30">30</option>
                            <option value="50">50</option>
                            <option value="å…¶å®ƒ">å…¶å®ƒ</option>
                        </select>
                    </div>
                    <div>
                        <label for="currentToothProfile" class="block text-sm font-medium text-gray-700">ç›®å‰ä½¿ç”¨é½’å‹ *</label>
                        <select id="currentToothProfile" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border bg-white">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="FT">å¹³é½’ (FT)</option>
                            <option value="ATB">å·¦å³æ–œé½’ (ATB)</option>
                            <option value="TCG">æ¢¯å½¢/å¹³é½’ (TCG)</option>
                            <option value="CATB">è¤‡åˆæ–œé½’ (CATB)</option>
                            <option value="å…¶ä»–">å…¶ä»–/ä¸çŸ¥é“</option>
                        </select>
                    </div>
                </div>

                <!-- åƒæ•¸è¨­å®š (2 æ¬„: è½‰é€Ÿ/åšåº¦) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="machineRPM" class="block text-sm font-medium text-gray-700">1. æ©Ÿå°è½‰é€Ÿ (RPM) *</label>
                        <input type="number" id="machineRPM" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border" placeholder="ä¾‹å¦‚ï¼š3000">
                    </div>
                    <div>
                        <label for="materialThickness" class="block text-sm font-medium text-gray-700">4. åˆ‡å‰Šç‰©åšåº¦ (mm) *</label>
                        <input type="number" id="materialThickness" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border" placeholder="ä¾‹å¦‚ï¼š10">
                    </div>
                </div>

                <!-- æè³ªèˆ‡å·¥ä»¶å½¢æ…‹ (2 æ¬„) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="cuttingMaterial" class="block text-sm font-medium text-gray-700">3. åˆ‡å‰Šç‰©ç¨®é¡ *</label>
                        <select id="cuttingMaterial" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border bg-white">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="æœ¨é ­">æœ¨é ­</option>
                            <option value="é‹åˆé‡‘">é‹åˆé‡‘</option>
                            <option value="ä¸é½é‹¼/éµ">ä¸é½é‹¼/éµ</option>
                            <option value="å£“å…‹åŠ›/å¡‘è† ">å£“å…‹åŠ›/å¡‘è† </option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label for="formFactor" class="block text-sm font-medium text-gray-700">5. æ€§è³ªæ•˜è¿° (å·¥ä»¶å½¢æ…‹) *</label>
                        <select id="formFactor" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border bg-white">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="æ¿">æ¿ (Plate)</option>
                            <option value="å¡Š">å¡Š (Block)</option>
                            <option value="ç®¡">ç®¡ (Tube)</option>
                            <option value="æ¢">æ¢ (Bar/Solid Rod)</option>
                            <option value="ç•°å‹æ">ç•°å‹æ (Extrusion)</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </div>

                <!-- åˆ‡å‰²é¡å‹ & å“ç‰Œ (2 æ¬„) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">6. åˆ‡å‰²é¡å‹ *</label>
                        <div class="flex space-x-4 bg-white p-2 rounded-md border">
                            <label class="inline-flex items-center">
                                <input type="radio" name="cutType" value="æ©«åˆ‡" required class="form-radio text-primary">
                                <span class="ml-2 text-gray-700">æ©«åˆ‡ (Cross-cut)</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="cutType" value="ç¸±åˆ‡" class="form-radio text-primary">
                                <span class="ml-2 text-gray-700">ç¸±åˆ‡ (Rip-cut)</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="cutType" value="å…©è€…çš†æœ‰" class="form-radio text-primary">
                                <span class="ml-2 text-gray-700">å…©è€…çš†æœ‰</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="currentBrand" class="block text-sm font-medium text-gray-700">8. ç›®å‰ä½¿ç”¨å“ç‰Œ</label>
                        <input type="text" id="currentBrand" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border" placeholder="ä¾‹å¦‚ï¼šHAWER, åœ‹å¤–å“ç‰Œ, ç„¡">
                    </div>
                </div>

                <!-- é‡åˆ°çš„å•é¡Œ (7) - å¢åŠ ã€Œå…¶ä»–ã€é¸é …å’Œè¼¸å…¥æ¡† -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">7. é‡åˆ°çš„ä¸»è¦å•é¡Œ (å¯è¤‡é¸) *</label>
                    <div class="space-y-2 flex flex-wrap gap-x-6 bg-white p-3 rounded-md border">
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="problem" value="å£½å‘½éçŸ­" class="form-checkbox text-red-600 rounded">
                            <span class="ml-2 text-gray-700">å£½å‘½éçŸ­/ç£¨æå¿«</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="problem" value="åˆ©åº¦ä¸è¶³" class="form-checkbox text-red-600 rounded">
                            <span class="ml-2 text-gray-700">åˆ©åº¦ä¸è¶³/é€²åˆ€æ…¢</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="problem" value="æ¯›é‚Šåš´é‡" class="form-checkbox text-red-600 rounded">
                            <span class="ml-2 text-gray-700">æ¯›é‚Šåš´é‡</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="problem" value="é‹¸ç‰‡æ²¾é»/ç©å±‘" class="form-checkbox text-red-600 rounded">
                            <span class="ml-2 text-gray-700">é‹¸ç‰‡æ²¾é»/ç©å±‘</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="problem" value="åˆ‡å‰²å™ªéŸ³éå¤§" class="form-checkbox text-red-600 rounded">
                            <span class="ml-2 text-gray-700">åˆ‡å‰²å™ªéŸ³éå¤§</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="problem" value="åˆ‡é¢æ­ªæ–œ" class="form-checkbox text-red-600 rounded">
                            <span class="ml-2 text-gray-700">åˆ‡é¢æ­ªæ–œ/ä¸å¹³æ•´</span>
                        </label>
                         <!-- æ–°å¢ï¼šå…¶ä»–é¸é … -->
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="problem" value="å…¶ä»–" id="otherProblemCheckbox" class="form-checkbox text-red-600 rounded">
                            <span class="ml-2 text-gray-700 font-bold text-red-600">å…¶ä»– (è«‹èªªæ˜)</span>
                        </label>
                    </div>
                    <!-- æ–°å¢ï¼šå…¶ä»–å•é¡Œæè¿°è¼¸å…¥æ¡† -->
                    <input type="text" id="customProblemDescription" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨é‡åˆ°çš„å…¶ä»–å•é¡Œ..." class="mt-2 hidden w-full rounded-md border-gray-300 shadow-sm p-2.5 border transition duration-300" disabled>
                    <input type="hidden" name="problemsCheck" required> 
                </div>

                <!-- ç…§ç‰‡åŠå½±ç‰‡é€£çµ (2 æ¬„) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="photoURL" class="block text-sm font-medium text-gray-700">åˆ‡é¢/å•é¡Œç…§ç‰‡é€£çµ (URL)</label>
                        <input type="url" id="photoURL" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border" placeholder="ä¾‹å¦‚ï¼šGoogleç›¸ç°¿æˆ–é›²ç«¯é€£çµ (å¯é¸å¡«)">
                    </div>
                    <div>
                        <label for="videoURL" class="block text-sm font-medium text-gray-700">åˆ‡å‰²å½±ç‰‡é€£çµ (URL)</label>
                        <input type="url" id="videoURL" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border" placeholder="ä¾‹å¦‚ï¼šYoutubeæˆ–é›²ç«¯é€£çµ (å¯é¸å¡«)">
                    </div>
                </div>
            </div>

            <!-- é‹¸ç‰‡é½’å‹çŸ¥è­˜åº« (æ²¿ç”¨) -->
            <details class="mb-8 p-5 rounded-lg shadow-md border-2 border-primary/50 bg-primary/10">
                <summary class="text-xl font-bold text-primary cursor-pointer py-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2h2a1 1 0 000-2H9z" clip-rule="evenodd" />
                    </svg>
                    é‹¸ç‰‡é½’å‹çŸ¥è­˜åº« (Tooth Profile Knowledge Base)
                </summary>
                <div class="mt-4 text-sm text-gray-700 overflow-x-auto">
                    <p class="mb-3">é‹¸ç‰‡åˆ€é ­çš„å¹¾ä½•å½¢ç‹€ï¼ˆé½’å‹ï¼‰æ±ºå®šäº†åˆ‡å‰Šæ–¹å¼ã€æ’å±‘èƒ½åŠ›å’Œåˆ‡é¢å“è³ªï¼Œæ˜¯é¸å‹è©•ä¼°çš„é—œéµã€‚</p>
                    <table class="min-w-full divide-y divide-gray-300 knowledge-table">
                        <thead>
                            <tr>
                                <th>é½’å‹ (Abbr.)</th>
                                <th>å…¨å</th>
                                <th>åˆ‡å‰Šç‰¹æ€§</th>
                                <th>é©ç”¨ææ–™</th>
                                <th>å¸¸è¦‹å•é¡Œè§£æ±º</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>**FT**</td>
                                <td>å¹³é½’ (Flat Top)</td>
                                <td>åˆ‡å‰ŠåŠ›é“å¼·ï¼Œå–®é½’è² è·å¤§ï¼Œæ’å±‘ç©ºé–“å¤§ã€‚</td>
                                <td>ç¸±åˆ‡å¯¦æœ¨ã€ä½ç¡¬åº¦é‡‘å±¬ã€é–‹æ§½ã€ç²—åˆ‡ã€‚</td>
                                <td>è§£æ±º**ç©å±‘ã€æ’å±‘ä¸è‰¯**ï¼Œä½†åˆ‡é¢è¼ƒç²—ç³™ã€‚</td>
                            </tr>
                            <tr>
                                <td>**ATB**</td>
                                <td>å·¦å³æ–œé½’ (Alternate Top Bevel)</td>
                                <td>åˆ‡å‰Šé˜»åŠ›å°ï¼Œåˆ‡é¢å…‰æ»‘ï¼Œé‹’åˆ©åº¦é«˜ã€‚</td>
                                <td>æ©«åˆ‡æœ¨æã€è† åˆæ¿ã€ä¸€èˆ¬äººé€ æ¿æã€‚</td>
                                <td>æ”¹å–„**æ©«åˆ‡æœ¨æçš„æ¯›é‚Š**ã€æä¾›**è‰¯å¥½åˆ‡é¢**ã€‚</td>
                            </tr>
                            <tr>
                                <td>**TCG**</td>
                                <td>æ¢¯å½¢/å¹³é½’ (Triple Chip Grind)</td>
                                <td>æ¢¯å½¢é½’è² è²¬ç²—åˆ‡ï¼Œå¾Œæ–¹å¹³é½’è² è²¬ç²¾ä¿®ï¼Œè€ç£¨æã€‚</td>
                                <td>**é‹åˆé‡‘ã€å£“å…‹åŠ›ã€å¡‘è† ã€è¤‡åˆæ¿æã€‚**</td>
                                <td>è§£æ±º**ééµé‡‘å±¬èåŒ–æ²¾é»**ã€é”åˆ°**é¡é¢**ç´šåˆ‡é¢ã€‚</td>
                            </tr>
                            <tr>
                                <td>**CATB**</td>
                                <td>è¤‡åˆæ–œé½’ (Combination ATB)</td>
                                <td>çµåˆå¹³é½’èˆ‡æ–œé½’ï¼Œè¬ç”¨å‹ï¼Œå¹³è¡¡åˆ‡å‰²é€Ÿåº¦èˆ‡åˆ‡é¢å“è³ªã€‚</td>
                                <td>æ©«åˆ‡ã€ç¸±åˆ‡æ··åˆæ‡‰ç”¨ï¼Œé«˜å¯†åº¦æ¿æã€‚</td>
                                <td>è¿½æ±‚**è¬ç”¨é‹¸ç‰‡**ï¼Œä½†æ•ˆæœå¯èƒ½ä¸å¦‚å°ˆç”¨é½’å‹ã€‚</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </details>

            <!-- å€å¡Šä¸‰ï¼šä½¿ç”¨ç‹€æ…‹è‡ªæˆ‘æª¢æ¸¬ -->
            <div class="p-5 rounded-lg mb-8 shadow-md border-2 border-accent/50 bg-accent/10">
                <h2 class="text-xl font-bold mb-4 text-accent border-b pb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-9a1 1 0 000 2h14a1 1 0 100-2H3z" clip-rule="evenodd" />
                    </svg>
                    å€å¡Šä¸‰ï¼šä½¿ç”¨ç‹€æ…‹è‡ªæˆ‘æª¢æ¸¬ (è«‹å‹™å¿…ç¢ºèª) *
                </h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-300">
                        <thead class="bg-white/50">
                            <tr>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider w-1/2">
                                    æª¢æ¸¬é …ç›®
                                </th>
                                <th scope="col" class="px-2 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    æ˜¯
                                </th>
                                <th scope="col" class="px-2 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    å¦
                                </th>
                                <th scope="col" class="px-2 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    æ²’æœ‰é€™åŠŸèƒ½
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="selfCheckTbody">
                            <!-- JS å‹•æ…‹ç”Ÿæˆé …ç›® -->
                        </tbody>
                    </table>
                </div>
            </div>
        
            <!-- å‹•ä½œæŒ‰éˆ• -->
            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <button type="button" onclick="generateReport()" id="generateButton" class="flex-1 w-full sm:w-auto px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-md text-white bg-primary submit-btn hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:pointer-events-none">
                    ç”Ÿæˆè©³ç´°å ±å‘Š (å« AI åˆ†æ)
                </button>
                <span id="loadingIndicator" class="ml-4 text-secondary font-medium hidden flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    AI æ­£åœ¨åˆ†æä¸­... è«‹ç¨å€™...
                </span>
                <button type="button" onclick="sendEmail()" id="emailButton" class="flex-1 w-full sm:w-auto px-6 py-3 border border-primary text-base font-medium rounded-lg shadow-md text-primary bg-white hover:bg-primary/10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out disabled:opacity-50 disabled:pointer-events-none" disabled>
                    å¯„é€å ±å‘Šåˆ°å…¬å¸ä¿¡ç®± (sales@hawer-knife.com)
                </button>
            </div>
        </form>

        <!-- å ±å‘Šè¼¸å‡ºå€ -->
        <div id="reportOutput" class="hidden mt-8 p-6 bg-gray-100 border border-gray-300 rounded-lg shadow-inner">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ç”Ÿæˆçš„è¨ºæ–·å ±å‘Š (å« AI å°ˆæ¥­åˆ†æ)</h2>
            <div id="reportContent" class="text-sm text-gray-700 max-h-96 overflow-y-auto p-4 bg-white rounded-md border report-section">
                <!-- å ±å‘Šå…§å®¹å°‡é¡¯ç¤ºåœ¨é€™è£¡ (Markdown æ¸²æŸ“) -->
            </div>
            <p class="text-xs text-gray-500 mt-3 text-center">è«‹é»æ“Šä¸Šæ–¹çš„ã€Œå¯„é€å ±å‘Šåˆ°å…¬å¸ä¿¡ç®±ã€æŒ‰éˆ•ï¼Œå°‡å…§å®¹ç™¼é€çµ¦ç›¸é—œäººå“¡æˆ–ç•™åº•ã€‚</p>
        </div>

    </div>
</div>

<!-- æç¤ºè¨Šæ¯ Modal -->
<div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
        <h3 id="modalTitle" class="text-lg font-bold text-gray-900 mb-3"></h3>
        <p id="modalMessage" class="text-sm text-gray-600 mb-4"></p>
        <button onclick="closeModal()" class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition">ç¢ºèª</button>
    </div>
</div>


<script type="module">
    // Firebase æ¨¡çµ„è¼‰å…¥ (ä¿ç•™æ¨™æº–åˆå§‹åŒ–ä»£ç¢¼)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // å…¨åŸŸè®Šæ•¸åˆå§‹åŒ– (ç”± Canvas ç’°å¢ƒæä¾›)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let db;
    let auth;
    let userId = null;

    // æç¤ºè¨Šæ¯åŠŸèƒ½
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const otherProblemCheckbox = document.getElementById('otherProblemCheckbox');
    const customProblemDescription = document.getElementById('customProblemDescription');
    const generateButton = document.getElementById('generateButton');
    const emailButton = document.getElementById('emailButton');
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    function openModal(title, message) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modal.classList.remove('hidden');
    }

    window.closeModal = function() {
        modal.classList.add('hidden');
    }
    
    // åˆå§‹åŒ– Firebase å’Œé©—è­‰ 
    async function initializeFirebase() {
        try {
            if (Object.keys(firebaseConfig).length === 0) {
                console.warn("Firebase config is empty. Skipping initialization.");
                return;
            }
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');

            await new Promise(resolve => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    unsubscribe();
                    resolve();
                });
            });

        } catch (error) {
            console.error("Firebase Initialization or Authentication Failed:", error);
        }
    }
    
    initializeFirebase();

    // é‹¸ç‰‡å°ˆå±¬çš„è‡ªæˆ‘æª¢æ¸¬å•é¡Œåˆ—è¡¨
    const sawbladeSelfCheckQuestions = [
        "åˆ‡å‰Šæ²¹/å†·å»æ¶²æ˜¯å¦æ­£å¸¸ä½¿ç”¨ï¼Ÿ (è‹¥ç‚ºä¹¾åˆ‡æ©Ÿå‰‡å¡« N/A)",
        "å·¥ä»¶äºŒé‚Šæ˜¯å¦æœ‰ç©©å›ºå¤¾ç·Šï¼Ÿ",
        "åˆ‡å‰Šç‰©æ˜¯å¦èˆ‡é‹¸ç‰‡å‘ˆ 90 åº¦ï¼Ÿ",
        "æ©Ÿå°ä¸»è»¸ã€çš®å¸¶æˆ–å¤¾å…·æ˜¯å¦æœ‰é¬†å‹•/ç•°å¸¸éœ‡å‹•ï¼Ÿ",
        "ä¸‹åˆ€å‰æ©Ÿå°æ˜¯å¦å·²é”åˆ°ç©©å®šè½‰é€Ÿï¼Ÿ",
        "é‹¸ç‰‡æ˜¯å¦æœ‰æŒ‰ç…§ç®­é ­æ–¹å‘æ­£ç¢ºå®‰è£ï¼Ÿ",
        "æ˜¯å¦å·²æª¢æŸ¥æ©Ÿå°é€²åˆ€é€Ÿåº¦ (é€²çµ¦ç‡) éå¿«ï¼Ÿ",
        "æ’å±‘æ˜¯å¦é †æš¢ï¼Ÿåˆ‡å±‘é¡è‰²æ˜¯å¦æ­£å¸¸ï¼Ÿ"
    ];

    // å…¨åŸŸè®Šæ•¸
    window.generatedReport = "";
    
    /**
     * åˆ‡æ›ã€Œå…¶ä»–å•é¡Œã€çš„è¼¸å…¥æ¡†é¡¯ç¤º
     */
    function toggleCustomProblemInput() {
        if (otherProblemCheckbox.checked) {
            customProblemDescription.classList.remove('hidden');
            customProblemDescription.disabled = false;
            customProblemDescription.focus();
        } else {
            customProblemDescription.classList.add('hidden');
            customProblemDescription.disabled = true;
            customProblemDescription.value = '';
        }
    }
    otherProblemCheckbox.addEventListener('change', toggleCustomProblemInput);


    /**
     * é‹¸ç‰‡é†«å­¸èªŒ (HAWER å°ˆæœ‰çŸ¥è­˜åº«ç²¾ç¥æ¨¡æ“¬)
     * æ ¹æ“šå®¢æˆ¶å›å ±çš„ã€ç—‡ç‹€ã€‘ï¼Œæä¾›ã€åŸå› ã€‘èˆ‡ã€å°ç­–ã€‘
     */
    const medicalJournal = {
        'å£½å‘½éçŸ­': { cause: 'è½‰é€Ÿ/é€²çµ¦ç‡ä¸ç•¶ï¼Œæˆ–å¤¾æŒä¸ç©©ã€‚', solution: 'æª¢æŸ¥è½‰é€Ÿæ˜¯å¦åŒ¹é…ç·šé€Ÿåº¦ï¼Œç¢ºä¿å¤¾æŒç©©å®šï¼Œè€ƒæ…®é«˜ç¡¬åº¦åˆé‡‘æˆ–å¡—å±¤é‹¸ç‰‡ã€‚', severity: 'é«˜é¢¨éšª' },
        'åˆ©åº¦ä¸è¶³': { cause: 'åˆ€å…·å·²ç£¨æã€é½’å‹ä¸é©åˆæˆ–æ©Ÿå°é¦¬åŠ›ä¸è¶³ã€‚', solution: 'ç¢ºèªæ˜¯å¦éœ€ç ”ç£¨ï¼Œæª¢æŸ¥å‰è§’æ˜¯å¦ç¬¦åˆææ–™ç‰¹æ€§ï¼Œç¢ºä¿æ©Ÿå°å‹•åŠ›è¶³å¤ ã€‚', severity: 'ä¸­é¢¨éšª' },
        'æ¯›é‚Šåš´é‡': { cause: 'T/t æ¯”ç‡éé«˜ï¼ˆé½’æ•¸å¤ªå¤šï¼‰æˆ–é½’å‹éŒ¯èª¤ï¼ˆæ‡‰ç‚º TCGï¼‰ã€‚', solution: 'æœ¨æé¡ç”¨ ATBï¼Œé‹åˆé‡‘/å¡‘è† å‹™å¿…ç”¨ TCGï¼Œä¸¦æª¢æŸ¥ T/t æ¯”ç‡æ˜¯å¦éé«˜ã€‚', severity: 'é«˜é¢¨éšª' },
        'é‹¸ç‰‡æ²¾é»/ç©å±‘': { cause: 'æ’å±‘ä¸è‰¯ã€ç·šé€Ÿåº¦å¤ªä½å°è‡´ç†”åŒ–ï¼Œæˆ–åˆ‡å‰Šæ²¹ä¸è¶³ã€‚', solution: 'æª¢æŸ¥åˆ‡å‰Šæ¶²ï¼Œä½¿ç”¨ TCG é½’å‹ï¼Œ**å¼·çƒˆå»ºè­°ä½¿ç”¨å°ˆç”¨æ’å±‘æ§½å½¢ç‹€æˆ–ä¸æ²¾é»å¡—å±¤**ã€‚', severity: 'é«˜é¢¨éšª' },
        'åˆ‡å‰²å™ªéŸ³éå¤§': { cause: 'é«˜é »æŒ¯å‹•ã€å…±æŒ¯ã€æ©Ÿå°æˆ–å¤¾å…·éœ‡å‹•ã€‚', solution: 'è€ƒæ…®ä½¿ç”¨å¸¶æœ‰ã€æ¶ˆéŸ³ç·šæˆ–é˜²éœ‡æ§½ã€‘è¨­è¨ˆçš„é‹¸ç‰‡ï¼Œæª¢æŸ¥æ©Ÿå°è»¸æ‰¿æ˜¯å¦å¹³è¡¡ï¼Œèª¿æ•´è½‰é€Ÿã€‚', severity: 'ä¸­é¢¨éšª' },
        'åˆ‡é¢æ­ªæ–œ': { cause: 'é‹¸ç‰‡è·³å‹•è®Šå½¢ã€ä¸»è»¸æˆ–æ³•è˜­é¬†å‹•ï¼Œæˆ–é€²çµ¦åŠ›é“ä¸å‡ã€‚', solution: 'æª¢æŸ¥é‹¸ç‰‡é‹¼æ¿ï¼Œæ¸¬é‡ä¸»è»¸è·³å‹•é‡ï¼Œç¢ºä¿å·¥ä»¶å®Œå…¨å›ºå®šã€‚', severity: 'ä¸­é¢¨éšª' }
    };

    /**
     * Helper function to generate the initial structured report data (excluding AI analysis).
     */
    function generateReportData() {
        const form = document.getElementById('sawbladeReportForm');
        const date = new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' });

        // æª¢æŸ¥å•é¡Œé¸é …
        let problemElements = document.querySelectorAll('input[name="problem"]:checked');
        let problemsArray = Array.from(problemElements).map(el => el.value);

        // è™•ç†ã€Œå…¶ä»–ã€é¸é …
        if (problemsArray.includes('å…¶ä»–')) {
            const customProblem = customProblemDescription.value.trim();
            if (customProblem) {
                // æ›¿æ› 'å…¶ä»–' ç‚ºå…·é«”æè¿°
                problemsArray = problemsArray.filter(p => p !== 'å…¶ä»–');
                problemsArray.push(`å…¶ä»– (å®¢æˆ¶æè¿°: ${customProblem})`);
            } else {
                // å¦‚æœå‹¾é¸äº†å…¶ä»–ä½†æœªå¡«å¯«ï¼Œå‰‡è¦–ç‚ºæœªå®Œæˆ
                customProblemDescription.classList.add('border-red-500');
                throw new Error('æ‚¨å‹¾é¸äº†ã€Œå…¶ä»–ã€ï¼Œè«‹å‹™å¿…å¡«å¯«é‡åˆ°çš„å•é¡Œæè¿°ã€‚');
            }
        }
        
        document.querySelector('input[name="problemsCheck"]').required = problemsArray.length === 0;

        // æª¢æŸ¥å¿…å¡«æ¬„ä½ (é€™è£¡åªåšåŸºç¤æª¢æŸ¥ï¼Œè©³ç´°äº¤çµ¦ isFormValid)
        const formElements = form.elements;
        
        // æ”¶é›†è‡ªæˆ‘æª¢æ¸¬çµæœ
        const selfCheckAnswers = [];
        for (let i = 0; i < sawbladeSelfCheckQuestions.length; i++) {
            const qId = `check_q${i + 1}`;
            const selected = formElements[qId]?.value;
            if (!selected) {
                 throw new Error('è«‹å®Œæˆæ‰€æœ‰å€å¡Šä¸‰çš„è‡ªæˆ‘æª¢æ¸¬å‹¾é¸ã€‚');
            }
            selfCheckAnswers.push({ question: sawbladeSelfCheckQuestions[i], answer: selected });
        }
        
        const problems = problemsArray.join(', ') || 'æœªé¸å–å•é¡Œ';
        
        // æ”¶é›†æ‰€æœ‰é—œéµæ•¸æ“š
        const clientName = formElements['name'].value;
        const companyName = formElements['companyName'].value || 'æœªæä¾›';
        const clientEmail = formElements['email'].value;
        const machineRPM = formElements['machineRPM'].value; // 1
        const outerDia = formElements['outerDia'].value; // 2
        const kerf = formElements['kerf'].value; // 2
        const toothCount = formElements['toothCount'].value; // 2
        const currentToothProfile = formElements['currentToothProfile'].value; // é½’å‹
        const innerDia = formElements['innerDia'].value;
        const cuttingMaterial = formElements['cuttingMaterial'].value; // 3
        const materialThickness = formElements['materialThickness'].value; // 4
        const formFactor = formElements['formFactor'].value; // 5
        const cutType = formElements['cutType'].value; // 6
        const currentBrand = formElements['currentBrand'].value || 'æœªæä¾›'; // 8
        const photoURL = formElements['photoURL'].value || 'ç„¡';
        const videoURL = formElements['videoURL'].value || 'ç„¡';
        
        
        // 1. å ±å‘Šé ­éƒ¨èˆ‡å®¢æˆ¶è³‡è¨Š (Markdown æ ¼å¼)
        let reportText = `# é‹¸ç‰‡å•é¡Œè¨ºæ–·å ±å‘Š (åˆæ­¥è©•ä¼°)\n\n`;
        reportText += `**ç”Ÿæˆæ™‚é–“ï¼š** ${date}\n\n`;
        
        reportText += `## å€å¡Šä¸€ï¼šå®¢æˆ¶åŠè¯ç¹«è³‡è¨Š\n`;
        reportText += `| é …ç›® | å…§å®¹ |\n`;
        reportText += `| :--- | :--- |\n`;
        reportText += `| **å…¬å¸åç¨±** | ${companyName} |\n`;
        reportText += `| **è¯çµ¡äºº** | ${clientName} |\n`;
        reportText += `| **é›»å­éƒµä»¶** | ${clientEmail} |\n\n`;

        // 2. é‹¸ç‰‡è¦æ ¼èˆ‡å•é¡Œ (ä¾ç…§ 8 å¤§è¦ç´ æ’åº)
        reportText += `## å€å¡ŠäºŒï¼šé‹¸ç‰‡è¦æ ¼ã€åƒæ•¸èˆ‡å•é¡Œæè¿° (8 å¤§è©•ä¼°è¦ç´ )\n`;
        reportText += `| é …ç›® | å…§å®¹ |\n`;
        reportText += `| :--- | :--- |\n`;
        reportText += `| **1. æ©Ÿå°è½‰é€Ÿ** | ${machineRPM} RPM |\n`; 
        reportText += `| **2. é‹¸ç‰‡è¦æ ¼** | å¤–å¾‘ ${outerDia} mm Ã— é½’åš ${kerf} mm Ã— é½’æ•¸ ${toothCount} T (å…§å¾‘: ${innerDia} mm) |\n`;
        reportText += `| **- ç›®å‰é½’å‹** | ${currentToothProfile} |\n`;
        reportText += `| **3. åˆ‡å‰Šç‰©ç¨®é¡** | ${cuttingMaterial} |\n`;
        reportText += `| **4. åˆ‡å‰Šç‰©åšåº¦** | ${materialThickness} mm |\n`; 
        reportText += `| **5. å·¥ä»¶å½¢æ…‹** | ${formFactor} |\n`; 
        reportText += `| **6. åˆ‡å‰²é¡å‹** | ${cutType} |\n`; 
        reportText += `| **8. ç›®å‰ä½¿ç”¨å“ç‰Œ** | ${currentBrand} |\n`; 
        reportText += `| **åˆ‡é¢/å•é¡Œç…§ç‰‡** | ${photoURL} |\n`;
        reportText += `| **åˆ‡å‰²å½±ç‰‡** | ${videoURL} |\n\n`; 
        
        reportText += `| **7. é‡åˆ°çš„ä¸»è¦å•é¡Œ** | **${problems}** |\n\n`;

        // 3. è‡ªæˆ‘æª¢æ¸¬çµæœ
        reportText += `## å€å¡Šä¸‰ï¼šä½¿ç”¨ç‹€æ…‹è‡ªæˆ‘æª¢æ¸¬çµæœ\n`;
        reportText += `| é …ç›® | æª¢æ¸¬çµæœ |\n`;
        reportText += `| :--- | :---: |\n`;
        selfCheckAnswers.forEach((item) => {
             reportText += `| ${item.question} | **${item.answer}** |\n`;
        });
        reportText += `\n`;
        
        // 4. åˆæ­¥è¨ºæ–·èˆ‡å»ºè­° (ç³»çµ±è‡ªå‹•ç”Ÿæˆï¼Œç„¡ AI åƒèˆ‡çš„éƒ¨åˆ†)
        reportText += `## é‹¸ç‰‡é†«å­¸èªŒï¼šæ•…éšœæ’é™¤èˆ‡å»ºè­° (HAWER çŸ¥è­˜åº«)\n`;

        if (problemsArray.length > 0) {
            reportText += `é‡å°æ‚¨å›å ±çš„ç—‡ç‹€ï¼Œæä¾›ã€åŸå› ã€‘èˆ‡ã€å»ºè­°å°ç­–ã€‘ï¼š\n\n`;
            
            reportText += `| ç—‡ç‹€ (Symptom) | åš´é‡ç­‰ç´š | ä¸»è¦åŸå›  (Cause) | å»ºè­°å°ç­– (Solution) |\n`;
            reportText += `| :--- | :---: | :--- | :--- |\n`;
            
            problemsArray.forEach(problem => {
                // æ’é™¤è‡ªè¨‚çš„ã€Œå…¶ä»–ã€é¸é …ï¼Œåªå°æ¨™æº–ç—‡ç‹€æä¾›é†«å­¸èªŒè¨ºæ–·
                const baseProblem = problem.includes('(å®¢æˆ¶æè¿°:') ? 'å…¶ä»–' : problem;
                const journalEntry = medicalJournal[baseProblem] || { cause: 'å®¢æˆ¶æè¿°å•é¡Œï¼Œç„¡æ¨™æº–é†«å­¸èªŒæ¢ç›®ã€‚', solution: 'éœ€ç”±å·¥ç¨‹å¸«å°ˆæ¥­åˆ¤æ–·ã€‚', severity: 'æœªçŸ¥' };
                
                // ç‚ºäº†è®“è¡¨æ ¼ç¾è§€ï¼Œå°‡å•é¡Œæ›¿æ›å›åŸå§‹çš„æˆ–ç°¡åŒ–çš„
                const displayProblem = problem.length > 30 ? problem.substring(0, 30) + '...' : problem;

                reportText += `| **${displayProblem}** | **${journalEntry.severity}** | ${journalEntry.cause} | ${journalEntry.solution} |\n`;
            });
            reportText += "\n";
            
        } else {
             reportText += "æœªé¸å–é‡åˆ°çš„å•é¡Œï¼Œè«‹å›åˆ°å€å¡ŠäºŒå‹¾é¸ï¼Œä»¥å•Ÿå‹•é†«å­¸èªŒè¨ºæ–·ã€‚\n\n";
        }
        
        // è¿”å›åŒ…å«æ‰€æœ‰æ•¸æ“šçš„åŸå§‹å ±å‘Šæ–‡å­—å’Œå•é¡Œé™£åˆ—
        return { reportText, problemsArray, clientEmail };
    }

    /**
     * å‘¼å« Gemini API é€²è¡Œå°ˆæ¥­åˆ†æ
     */
    async function getAIAnalysis(reportText) {
        const apiKey = ""; // Canvas Runtimeå°‡è‡ªå‹•æä¾›API Key
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // System prompt for the AI
        const systemPrompt = "ä½ æ˜¯ä¸€ä½æ“æœ‰è¶…é30å¹´ç¶“é©—çš„å°ˆæ¥­é‹¸ç‰‡æ‡‰ç”¨å·¥ç¨‹å¸«ï¼Œå°ˆé–€ç‚ºå®¢æˆ¶æä¾›ç²¾æº–çš„é‹¸ç‰‡å•é¡Œè¨ºæ–·å’Œç”¢å“é¸å‹å»ºè­°ã€‚è«‹æ ¹æ“šæä¾›çš„é‹¸ç‰‡è¨ºæ–·å ±å‘Šï¼Œé€²è¡Œç°¡æ½”ã€å°ˆæ¥­çš„ç¸½çµèˆ‡å»ºè­°ã€‚è¼¸å‡ºæ ¼å¼å¿…é ˆæ˜¯Markdownï¼Œä¸¦åŒ…å«ä»¥ä¸‹å…©å€‹é ‚ç´šæ¨™é¡Œï¼š1. AI å°ˆæ¥­ç¸½çµ (ç¸½çµå•é¡Œé»å’Œé¢¨éšª)ã€2. ç”¢å“é¸å‹æˆ–å„ªåŒ–å»ºè­° (æä¾›å…·é«”æ“ä½œæˆ–ç”¢å“æ–¹å‘)ã€‚æ‰€æœ‰å…§å®¹æ‡‰ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚è«‹é¿å…ä½¿ç”¨å†—é¤˜çš„é–‹é ­å’Œçµå°¾èªå¥ã€‚";

        const userQuery = `è«‹åˆ†æä»¥ä¸‹å®¢æˆ¶æä¾›çš„é‹¸ç‰‡è¨ºæ–·å ±å‘Šï¼Œä¸¦çµ¦äºˆå°ˆæ¥­å»ºè­°ï¼š\n\n${reportText}`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        try {
            // Implement simple retry with exponential backoff (e.g., 1s, 2s)
            let response;
            let result;
            const maxRetries = 2;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                result = await response.json();
                
                if (response.ok && result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                }
                
                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }

            console.error("AI Response failed after retries:", result);
            return "AI å°ˆæ¥­åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API è¨­ç½®æˆ–ç¨å¾Œå†è©¦ã€‚";
            
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            return `AI æœå‹™å‘¼å«å¤±æ•—: ${error.message}`;
        }
    }


    /**
     * æ ¸å¿ƒåŠŸèƒ½ï¼šæ”¶é›†æ‰€æœ‰è³‡è¨Šä¸¦ç”Ÿæˆç´”æ–‡å­—å ±å‘Š
     */
    window.generateReport = async function() {
        // UI ç‹€æ…‹ï¼šç¦ç”¨æŒ‰éˆ•ï¼Œé¡¯ç¤ºè¼‰å…¥ä¸­
        generateButton.disabled = true;
        emailButton.disabled = true;
        loadingIndicator.classList.remove('hidden');

        const reportOutput = document.getElementById('reportOutput');
        const reportContent = document.getElementById('reportContent');
        
        try {
            const { reportText: rawReportText, problemsArray, clientEmail } = generateReportData();
            
            // --- å‘¼å« AI é€²è¡Œåˆ†æ ---
            const aiAnalysis = await getAIAnalysis(rawReportText);
            
            // --- å°‡ AI åˆ†æçµæœåŠ å…¥å ±å‘Š ---
            let fullReportText = rawReportText;
            fullReportText += `\n## AI æ™ºæ…§è¨ºæ–· (Gemini å°ˆæ¥­å·¥ç¨‹å¸«)\n`;
            fullReportText += aiAnalysis;
            fullReportText += `\n\n----\n`;
            
            // --- ç¸½çµå»ºè­° (é AI åƒèˆ‡çš„éƒ¨åˆ†) ---
            let advice = "## æ“ä½œç’°å¢ƒæª¢æŸ¥ç¸½çµèˆ‡å¾ŒçºŒæ­¥é©Ÿ\n";
            const selfCheckAnswers = document.querySelectorAll('#selfCheckTbody input:checked');
            const answers = Array.from(selfCheckAnswers).map(el => el.value);

            if (answers.includes('å¦')) {
                advice += "### ğŸ”´ è­¦å‘Šï¼šæ“ä½œè¨­å®šå­˜åœ¨å•é¡Œ\n";
                advice += "æ ¹æ“šæ‚¨çš„è‡ªæˆ‘æª¢æ¸¬çµæœï¼Œéƒ¨åˆ†é—œéµæ“ä½œï¼ˆå¦‚å·¥ä»¶å¤¾ç·Šã€åˆ€å…·æ–¹å‘ã€é€²çµ¦é€Ÿåº¦ï¼‰å¯èƒ½æœªé”æ¨™æº–ã€‚é€™æ˜¯é€ æˆåˆ‡å‰²å“è³ªå•é¡Œæˆ–åˆ€å…·æå£çš„**æœ€å¸¸è¦‹åŸå› **ã€‚è«‹å„ªå…ˆæª¢æŸ¥æ‰€æœ‰å›ç­”ã€Œå¦ã€çš„é …ç›®ï¼\n\n";
            } else if (answers.every(a => a === 'æ˜¯' || a === 'æ²’æœ‰é€™åŠŸèƒ½')) {
                advice += "### ğŸŸ¢ æ“ä½œç’°å¢ƒæ¨™æº–\n";
                advice += "æ‚¨çš„æ“ä½œç’°å¢ƒä¼¼ä¹å·²é”æ¨™ã€‚è‹¥åˆ‡å‰²å“è³ªä»ä¸ä½³ï¼Œå•é¡Œå¾ˆå¯èƒ½åœ¨æ–¼é‹¸ç‰‡é¸å‹ã€é½’å‹ä¸å°æˆ–æ©Ÿå°çš„é¦¬åŠ›èˆ‡æ‰­åŠ›ä¸è¶³ã€‚è«‹å°‡æ­¤å ±å‘Šç™¼é€çµ¦æŠ€è¡“é¡§å•é€²è¡Œå°ˆæ¥­é¸å‹æª¢æŸ¥ã€‚\n\n";
            }
            
            advice += `### â¡ï¸ ä¸‹ä¸€æ­¥ï¼šå¯„é€å ±å‘Š\n`;
            advice += `è«‹é»æ“Šä¸Šæ–¹çš„ **ã€Œå¯„é€å ±å‘Šåˆ°å…¬å¸ä¿¡ç®±ã€** æŒ‰éˆ•ï¼Œå°‡æ­¤å ±å‘Šç™¼é€çµ¦ ${clientEmail} (å®¢æˆ¶) åŠ **sales@hawer-knife.com** (å…¬å¸)ã€‚æˆ‘å€‘çš„æŠ€è¡“é¡§å•å°‡æœƒç›¡å¿«èˆ‡æ‚¨è¯ç¹«ï¼\n`;
            
            fullReportText += advice;
            fullReportText += `\n==== å ±å‘ŠçµæŸ ====\n`;
            
            
            // ç”±æ–¼ reportContent æ¸²æŸ“ Markdownï¼Œæˆ‘å€‘ç›´æ¥å°‡ Markdown å…§å®¹è¨­ç½®ç‚º innerText
            // ä½†ç‚ºäº†æ–¹ä¾¿è¤‡è£½åˆ°éƒµä»¶ï¼Œæˆ‘å€‘å°‡ Markdown ä¹Ÿå­˜åˆ°å…¨åŸŸè®Šæ•¸
            window.generatedReport = fullReportText;
            
            // ç°¡æ˜“çš„ Markdown è½‰ HTML æ¸²æŸ“ (åƒ…ç”¨æ–¼é¡¯ç¤ºï¼Œéƒµä»¶ä¸­ä»å‚³é€ç´” Markdown æ–‡å­—)
            reportContent.innerHTML = renderMarkdownToHtml(fullReportText);
            
            reportOutput.classList.remove('hidden');

            openModal('å ±å‘Šç”ŸæˆæˆåŠŸ', 'è¨ºæ–·å ±å‘Šå·²åœ¨ä¸‹æ–¹é¡¯ç¤ºï¼Œä¸¦åŒ…å«äº† AI å°ˆæ¥­åˆ†æã€‚æ‚¨ç¾åœ¨å¯ä»¥é»æ“Šã€Œå¯„é€å ±å‘Šåˆ°å…¬å¸ä¿¡ç®±ã€æŒ‰éˆ•ã€‚');

        } catch (error) {
            console.error("ç”Ÿæˆå ±å‘Šå¤±æ•—:", error);
            openModal('ç”Ÿæˆå ±å‘Šå¤±æ•—', error.message || 'è«‹æª¢æŸ¥æ‰€æœ‰å¿…å¡«æ¬„ä½æ˜¯å¦å·²å®Œæˆã€‚');
        } finally {
            // UI ç‹€æ…‹ï¼šæ¢å¾©æŒ‰éˆ•ï¼Œéš±è—è¼‰å…¥ä¸­
            generateButton.disabled = false;
            emailButton.disabled = window.generatedReport ? false : true;
            loadingIndicator.classList.add('hidden');
        }
    };
    
    /**
     * ç°¡æ˜“ Markdown è½‰æ›ç‚º HTML (åƒ…ç”¨æ–¼ç¾è§€é¡¯ç¤ºåœ¨é è¦½å€)
     */
    function renderMarkdownToHtml(markdown) {
        let html = markdown
            .replace(/^#\s+(.*)$/gm, '<h1>$1</h1>')
            .replace(/^##\s+(.*)$/gm, '<h2>$1</h2>')
            .replace(/^###\s+(.*)$/gm, '<h3>$1</h3>')
            .replace(/\|([^|]*)\|([^|]*)\|/g, (match, p1, p2) => `<tr><td>${p1.trim()}</td><td>${p2.trim()}</td></tr>`) // Simple table row conversion
            .replace(/^- (.*)$/gm, '<li>$1</li>')
            .replace(/^(<li>.*<\/li>)$/gms, '<ul>$1</ul>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>');
            
        // è™•ç†è¡¨æ ¼é ­
        html = html.replace(/\|(.*)\|/g, (match) => {
            if (match.includes(':---') || match.includes(':---:')) return ''; // Remove separator lines
            if (match.includes('é …ç›®') || match.includes('ç—‡ç‹€')) {
                return match.replace(/\|([^|]*)\|/g, (m, p) => `<th>${p.trim()}</th>`).replace('<th>', '<thead><tr>').replace(/<\/th>$/, '</th></tr></thead><tbody>');
            }
            return match;
        });
        
        // Final table wrapping (crude but functional)
        if (html.includes('<thead>')) {
            html = '<table>' + html + '</tbody></table>';
        }
        
        // ç¢ºä¿æ‰€æœ‰æ›è¡Œç¬¦è™Ÿéƒ½è¢« <br> å–ä»£ï¼Œé™¤éå®ƒå€‘åœ¨ç‰¹å®šå¡Šä¸­
        html = html.split('\n').map(line => {
            if (line.match(/<h[123]>/) || line.match(/<ul/) || line.match(/<table/)) {
                return line;
            }
            return line.trim().length > 0 ? line : '<br>';
        }).join('');
        
        return html;
    }


    /**
     * æ ¸å¿ƒåŠŸèƒ½ï¼šå¯„é€å ±å‘Šåˆ°å…¬å¸ä¿¡ç®±
     */
    window.sendEmail = function() {
        if (!window.generatedReport) {
            openModal('æ“ä½œå¤±æ•—', 'è«‹å…ˆç”Ÿæˆå ±å‘Šå¾Œå†å˜—è©¦å¯„é€ã€‚');
            return;
        }

        const clientEmail = document.getElementById('email').value;
        const companyName = document.getElementById('companyName').value || 'æœªç½²åå®¢æˆ¶';

        // è¨­å®šæ”¶ä»¶äººç‚ºå…¬å¸ä¿¡ç®±
        const recipient = 'sales@hawer-knife.com'; 
        
        // è¨­å®šä¸»æ—¨
        const subject = encodeURIComponent(`ã€æ–°é‹¸ç‰‡è¨ºæ–·å ±å‘Šã€‘å¾…è™•ç† - å®¢æˆ¶: ${companyName} (${clientEmail})`);
        
        // åœ¨å ±å‘Šå…§å®¹å‰åŠ ä¸Šå®¢æˆ¶ä¿¡ç®±ï¼Œæ–¹ä¾¿å›è¦†
        const reportBodyWithClientInfo = `ã€æ­¤å ±å‘Šç”±å®¢æˆ¶å¡«å¯«ï¼Œè«‹å„ªå…ˆè™•ç†ã€‘\nå®¢æˆ¶è¯çµ¡ä¿¡ç®±: ${clientEmail}\n-----------------------------------\n\n${window.generatedReport}`;
        const body = encodeURIComponent(reportBodyWithClientInfo);
        
        // æ§‹å»º mailto é€£çµ
        // å°‡å®¢æˆ¶ä¿¡ç®±æ”¾åœ¨ cc æˆ– reply-toï¼Œé€™è£¡é¸æ“‡åœ¨ body ä¸­å¼·èª¿ï¼Œä¸¦è®“å®¢æˆ¶çŸ¥é“ä¿¡ä»¶æœƒå¯„çµ¦å…¬å¸
        const mailtoLink = `mailto:${recipient}?subject=${subject}&body=${body}`;
        
        try {
            window.location.href = mailtoLink;
        } catch (e) {
            console.error("ç„¡æ³•é–‹å•Ÿ mailto é€£çµ:", e);
            openModal('å¯„ä¿¡å¤±æ•—', 'ç„¡æ³•é–‹å•Ÿéƒµä»¶å®¢æˆ¶ç«¯ã€‚è«‹æª¢æŸ¥æ‚¨çš„ç€è¦½å™¨è¨­å®šï¼Œæˆ–æ‰‹å‹•è¤‡è£½ä¸‹æ–¹å ±å‘Šå…§å®¹é€²è¡Œå¯„é€ã€‚');
            return;
        }
        
        openModal('æ­£åœ¨é–‹å•Ÿéƒµä»¶å®¢æˆ¶ç«¯', `å ±å‘Šå·²æº–å‚™å¥½ï¼Œæ”¶ä»¶äººå·²è¨­å®šç‚º **${recipient}**ã€‚è«‹ç¢ºèªå…§å®¹ä¸¦ç™¼é€ã€‚`);
    };
    
    // åˆå§‹åŒ–è‡ªæˆ‘æª¢æ¸¬è¡¨æ ¼
    function initializeSelfCheckTable() {
        const tbody = document.getElementById('selfCheckTbody');
        tbody.innerHTML = ''; 
        
        sawbladeSelfCheckQuestions.forEach((q, index) => {
            const qId = `check_q${index + 1}`;
            const row = document.createElement('tr');
            row.className = index % 2 === 0 ? 'bg-white hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
            
            row.innerHTML = `
                <td class="px-3 py-3 text-sm font-medium text-gray-900">${index + 1}. ${q}</td>
                ${['æ˜¯', 'å¦', 'æ²’æœ‰é€™åŠŸèƒ½'].map((label, i) => `
                    <td class="px-2 py-3 text-sm text-gray-500 text-center">
                        <input type="radio" id="${qId}_${i}" name="${qId}" value="${label}" class="h-4 w-4 text-primary border-gray-300 focus:ring-secondary" required>
                        <label for="${qId}_${i}" class="sr-only">${label}</label>
                    </td>
                `).join('')}
            `;
            tbody.appendChild(row);
        });
    }

    document.addEventListener('DOMContentLoaded', initializeSelfCheckTable);
    
</script>

</body>
</html>